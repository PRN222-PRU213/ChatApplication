<Window x:Class="ChatApplication.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:ChatApplication"
        mc:Ignorable="d"
        Title="💬 Group Chat"
        Height="650"
        Width="480"
        WindowStartupLocation="CenterScreen"
        Background="#ECE5DD">

    <Window.Resources>
        <local:BoolToAlignmentConverter x:Key="BoolToAlignmentConverter" />
        <local:BoolToColorConverter x:Key="BoolToColorConverter" />
        <BooleanToVisibilityConverter x:Key="BoolToVisibility" />
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- ========== HEADER + KẾT NỐI ========== -->
        <Border Grid.Row="0" Background="#075E54" Padding="15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Tiêu đề -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                    <TextBlock Text="💬 Group Chat"
                               FontSize="18"
                               FontWeight="Bold"
                               Foreground="White"
                               VerticalAlignment="Center" />
                    <Border Background="{Binding IsConnected, Converter={StaticResource BoolToColorConverter}}"
                            CornerRadius="5"
                            Padding="8,3"
                            Margin="15,0,0,0"
                            VerticalAlignment="Center">
                        <TextBlock Text="{Binding ConnectionStatus}"
                                   Foreground="White"
                                   FontSize="11" />
                    </Border>
                </StackPanel>

                <!-- Form kết nối -->
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="60" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="Tên:" Foreground="White" VerticalAlignment="Center" Margin="0,0,8,0" />
                    <TextBox Grid.Column="1"
                             Text="{Binding UserName, UpdateSourceTrigger=PropertyChanged}"
                             IsEnabled="{Binding IsNotConnected}"
                             Padding="8,5"
                             FontSize="13" />

                    <TextBlock Grid.Column="2" Text="IP:" Foreground="White" VerticalAlignment="Center" Margin="10,0,8,0" />
                    <TextBox Grid.Column="3"
                             Text="{Binding ServerIP, UpdateSourceTrigger=PropertyChanged}"
                             IsEnabled="{Binding IsNotConnected}"
                             Padding="8,5"
                             FontSize="13" />

                    <Button Grid.Column="4"
                            Content="Kết nối"
                            Command="{Binding ConnectCommand}"
                            IsEnabled="{Binding IsNotConnected}"
                            Padding="15,5"
                            Margin="10,0,0,0"
                            Background="#25D366"
                            Foreground="White"
                            BorderThickness="0"
                            FontWeight="SemiBold"
                            Cursor="Hand" />
                </Grid>
            </Grid>
        </Border>

        <!-- ========== DANH SÁCH TIN NHẮN ========== -->
        <ListBox Grid.Row="1"
                 ItemsSource="{Binding Messages}"
                 Background="#ECE5DD"
                 BorderThickness="0"
                 Padding="10"
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                 ScrollViewer.VerticalScrollBarVisibility="Auto"
                 HorizontalContentAlignment="Stretch">

            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="Margin" Value="0,3" />
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderThickness" Value="0" />
                    <Setter Property="Focusable" Value="False" />
                </Style>
            </ListBox.ItemContainerStyle>

            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Grid>
                        <Border Padding="10,8"
                                Margin="{Binding Margin}"
                                MaxWidth="320"
                                CornerRadius="8"
                                HorizontalAlignment="{Binding IsMine, Converter={StaticResource BoolToAlignmentConverter}}">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Background" Value="White" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsMine}" Value="True">
                                            <Setter Property="Background" Value="#DCF8C6" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding User}" Value="SYSTEM">
                                            <Setter Property="Background" Value="#FFF9C4" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding User}" Value="FILE">
                                            <Setter Property="Background" Value="#BBDEFB" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding User}" Value="UPLOAD">
                                            <Setter Property="Background" Value="#C8E6C9" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsDownloaded}" Value="True">
                                            <Setter Property="Background" Value="#A5D6A7" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>

                            <StackPanel>
                                <!-- Tên người gửi -->
                                <TextBlock Text="{Binding User}"
                                           FontWeight="Bold"
                                           FontSize="11"
                                           Foreground="#075E54"
                                           Margin="0,0,0,4">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsMine}" Value="True">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>

                                <!-- Nội dung -->
                                <TextBlock Text="{Binding Message}"
                                           TextWrapping="Wrap"
                                           FontSize="14"
                                           Foreground="#303030" />

                                <!-- Progress bar -->
                                <ProgressBar Value="{Binding Progress}"
                                             Height="4"
                                             Margin="0,8,0,0"
                                             Foreground="#075E54"
                                             Visibility="{Binding IsReceiving, Converter={StaticResource BoolToVisibility}}" />

                                <!-- Nút tải xuống -->
                                <Button Content="⬇ Tải xuống"
                                        Margin="0,8,0,0"
                                        Padding="10,5"
                                        Background="#075E54"
                                        Foreground="White"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        Command="{Binding DownloadCommand}"
                                        Visibility="{Binding IsReadyToDownload, Converter={StaticResource BoolToVisibility}}" />

                                <!-- Đã tải -->
                                <TextBlock Text="✓ Đã tải xuống"
                                           FontSize="11"
                                           Foreground="#2E7D32"
                                           FontWeight="SemiBold"
                                           Margin="0,5,0,0"
                                           Visibility="{Binding IsDownloaded, Converter={StaticResource BoolToVisibility}}" />
                            </StackPanel>
                        </Border>
                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- ========== EMOJI ========== -->
        <Border Grid.Row="2" Background="White" Padding="8">
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                <ItemsControl ItemsSource="{Binding Emojis}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Content="{Binding}"
                                    FontSize="20"
                                    Width="38"
                                    Height="38"
                                    Margin="2"
                                    Background="#F0F0F0"
                                    BorderThickness="0"
                                    Cursor="Hand"
                                    Command="{Binding DataContext.AddEmojiCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                    CommandParameter="{Binding}"
                                    IsEnabled="{Binding DataContext.IsConnected, RelativeSource={RelativeSource AncestorType=Window}}" />
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>

        <!-- ========== INPUT ========== -->
        <Border Grid.Row="3" Background="#F0F0F0" Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Nút gửi file -->
                <Button Grid.Column="0"
                        Width="40"
                        Height="40"
                        FontSize="18"
                        Background="#E0E0E0"
                        BorderThickness="0"
                        Cursor="Hand"
                        Command="{Binding SendFileCommand}"
                        IsEnabled="{Binding CanSendFile}"
                        ToolTip="Gửi file (có thể chọn nhiều)">
                    <Button.Content>
                        <TextBlock Text="📎">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsSendingFiles}" Value="True">
                                            <Setter Property="Text" Value="⏳" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Button.Content>
                </Button>

                <!-- Input text -->
                <TextBox Grid.Column="1"
                         Text="{Binding InputMessage, UpdateSourceTrigger=PropertyChanged}"
                         Padding="12,10"
                         FontSize="14"
                         Margin="10,0"
                         BorderThickness="1"
                         BorderBrush="#CCC"
                         IsEnabled="{Binding IsConnected}"
                         VerticalContentAlignment="Center" />

                <!-- Nút gửi -->
                <Button Grid.Column="2"
                        Content="➤"
                        Width="45"
                        Height="40"
                        FontSize="18"
                        Background="#075E54"
                        Foreground="White"
                        BorderThickness="0"
                        Cursor="Hand"
                        Command="{Binding SendCommand}"
                        IsEnabled="{Binding IsConnected}" />
            </Grid>
        </Border>
    </Grid>
</Window>